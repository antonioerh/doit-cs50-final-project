{% extends "layout.html" %}

{% block title %}
    Create routine - Striation
{% endblock %}
    <div class="container" style="max-width: 1000px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">New routine</h1>
    <a class="btn btn-outline-secondary" href="{{ url_for('routines') }}">Cancel</a>
  </div>

  <form action="{{ url_for('routine_create') }}" method="post" id="routineForm" class="card shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label" for="name">Routine name</label>
          <input class="form-control" id="name" name="name" maxlength="40" required autofocus>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="notes">Notes (optional)</label>
          <input class="form-control" id="notes" name="notes" maxlength="300">
        </div>

        <hr class="my-2">

        <div class="col-md-6">
          <label class="form-label" for="exerciseSelect">Exercise</label>
          <select class="form-select" id="exerciseSelect">
            <option value="" selected disabled>Choose an exercise...</option>
            {% for e in exercises %}
              <option value="{{ e.id }}">{{ e.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label" for="setsInput">Sets</label>
          <input class="form-control" id="setsInput" type="number" min="1" max="99" placeholder="e.g. 3">
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label" for="repsInput">Reps</label>
          <input class="form-control" id="repsInput" type="number" min="1" max="999" placeholder="e.g. 8">
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label" for="restInput">Rest (s)</label>
          <input class="form-control" id="restInput" type="number" min="0" max="3600" placeholder="e.g. 90">
        </div>

        <div class="col-12">
          <button class="btn btn-primary w-100" type="button" id="addExerciseBtn">
            Add to routine
          </button>
        </div>

        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h6 mb-0">Exercises in routine</h2>
            <small class="text-muted" id="countLabel">0 added</small>
          </div>

          <ul class="list-group" id="exerciseList"></ul>

          <!-- hidden inputs entram aqui -->
          <div id="hiddenInputs"></div>

          <div class="mt-3">
            <button class="btn btn-success w-100" type="submit">
              Create routine
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
(() => {
  const select = document.getElementById("exerciseSelect");
  const setsInput = document.getElementById("setsInput");
  const repsInput = document.getElementById("repsInput");
  const restInput = document.getElementById("restInput");

  const addBtn = document.getElementById("addExerciseBtn");
  const list = document.getElementById("exerciseList");
  const hidden = document.getElementById("hiddenInputs");
  const countLabel = document.getElementById("countLabel");
  const form = document.getElementById("routineForm");

  let count = 0;
  let rowId = 0; // permite repetidos com ids Ãºnicos

  function updateCount() {
    countLabel.textContent = `${count} added`;
  }

  function clampInt(value, min, max) {
    const s = (value ?? "").toString().trim();
    if (s === "") return "";
    const n = Number.parseInt(s, 10);
    if (Number.isNaN(n)) return "";
    if (n < min) return String(min);
    if (n > max) return String(max);
    return String(n);
  }

  function addExercise() {
    const exId = select.value;
    if (!exId) return;

    const exName = select.options[select.selectedIndex].text;

    const sets = clampInt(setsInput.value, 1, 99);
    const reps = clampInt(repsInput.value, 1, 999);
    const rest = clampInt(restInput.value, 0, 3600);

    rowId += 1;
    const idSuffix = `${rowId}`;

    // item visual
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.dataset.rowId = idSuffix;

    const left = document.createElement("div");
    left.innerHTML = `
      <div class="fw-semibold">${exName}</div>
      <div class="text-muted small">
        Sets: <span class="me-2">${sets || "-"}</span>
        Reps: <span class="me-2">${reps || "-"}</span>
        Rest: <span>${rest || "-"}</span>
      </div>
    `;

    const right = document.createElement("div");
    right.className = "d-flex gap-2";

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "btn btn-sm btn-outline-danger";
    removeBtn.textContent = "Remove";
    removeBtn.addEventListener("click", () => removeRow(idSuffix));

    right.appendChild(removeBtn);

    li.appendChild(left);
    li.appendChild(right);
    list.appendChild(li);

    // hidden inputs ALINHADOS (ordem importa)
    const exInput = document.createElement("input");
    exInput.type = "hidden";
    exInput.name = "exercise_ids[]";
    exInput.value = exId;
    exInput.id = `ex-${idSuffix}`;

    const setsHidden = document.createElement("input");
    setsHidden.type = "hidden";
    setsHidden.name = "sets[]";
    setsHidden.value = sets;
    setsHidden.id = `sets-${idSuffix}`;

    const repsHidden = document.createElement("input");
    repsHidden.type = "hidden";
    repsHidden.name = "reps[]";
    repsHidden.value = reps;
    repsHidden.id = `reps-${idSuffix}`;

    const restHidden = document.createElement("input");
    restHidden.type = "hidden";
    restHidden.name = "rest_seconds[]";
    restHidden.value = rest;
    restHidden.id = `rest-${idSuffix}`;

    hidden.appendChild(exInput);
    hidden.appendChild(setsHidden);
    hidden.appendChild(repsHidden);
    hidden.appendChild(restHidden);

    count += 1;
    updateCount();

    // limpa inputs (opcional)
    select.value = "";
    setsInput.value = "";
    repsInput.value = "";
    restInput.value = "";
  }

  function removeRow(idSuffix) {
    const li = list.querySelector(`li[data-row-id="${idSuffix}"]`);
    if (li) li.remove();

    ["ex", "sets", "reps", "rest"].forEach(prefix => {
      const el = document.getElementById(`${prefix}-${idSuffix}`);
      if (el) el.remove();
    });

    count = Math.max(0, count - 1);
    updateCount();
  }

  addBtn.addEventListener("click", addExercise);

  form.addEventListener("submit", (e) => {
    if (count === 0) {
      e.preventDefault();
      alert("Add at least one exercise.");
    }
  });

  updateCount();
})();
</script>
{% block main %}

{% endblock %}